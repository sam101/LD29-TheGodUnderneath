function Cursor(){this.x=WIDTH/2,this.y=HEIGHT/2,this.addState=0,this.removeState=0}function Game(a){var b=this;this.canvasElement=document.getElementById("game"),this.canvas=this.canvasElement.getContext("2d"),this.canvas.width=16*TILE_SIZE,this.canvas.height=12*TILE_SIZE+8,this.id=a.id,this.changeSize(a.size),this.cursor=new Cursor,this.goal=new Goal(a.goal),this.player=new Player(a.player),this.lifebar=new LifeBar(a.player),this.otherPlayers=new OtherPlayers,this.world=new World(a.tiles),this.started=!0,this.keyboard={status:{},onKeydown:function(a){a.preventDefault(),this.status[a.keyCode]=!0},onKeyup:function(a){delete this.status[a.keyCode]}},$("body").on("keydown",function(a){b.keyboard.onKeydown(a)}),$("body").on("keyup",function(a){b.keyboard.onKeyup(a)}),$("body").on("keydown",function(a){a.preventDefault()}),window.requestAnimationFrame(function(){b.draw()}),this.frameCount=0,this.diff=0,this.lastTime=Date.now()}function gameOver(a){$("body").off("keydown"),socket.disconnect(),sound.LOSE.play(),$(".points").html(""+a),$("#gamePlay").slideUp(INTRODUCTION_DELAY),setTimeout(function(){$("#gameOver").slideDown(INTRODUCTION_DELAY)},INTRODUCTION_DELAY)}function Goal(a){this.data=a}function LifeBar(a){this.player=a}function initGame(){socket=io.connect(),socket.on("changeMode",function(a){ui.changeMode(a?"god":"normal"),game.player.isGod=a}),socket.on("changeSize",function(a){game.started&&game.changeSize(a)}),socket.on("changeWorld",function(a){game.changeWorld(a)}),socket.on("disconnect",function(){game.started=!1,ui.showInfo("Waiting for server...")}),socket.on("waitingForPlayers",function(){game.started=!1,ui.showInfo("Waiting for players...")}),socket.on("gameOver",function(a){gameOver(a)}),socket.on("initialData",function(a){ui.changeMode("normal"),game=new Game(a)}),socket.on("otherPlayerData",function(a){game.started&&game.otherPlayers.updatePosition(a)}),socket.on("removePlayer",function(a){game.started&&game.removePlayer(a)}),socket.on("tileData",function(a){game.started&&game.world.updateTile(a.x,a.y,a.tile)}),socket.on("updateRocks",function(a){game.started&&game.world.updateRocks(a)}),socket.on("updateLife",function(a){game.started&&game.lifebar.updateLife(a)})}function OtherPlayers(){this.players={}}function Player(a){this.data=a,this.isGod=!1,this.attackState={n:0}}function Tile(){}function UI(){}function World(a){this.data=a,this.height=a.length,this.rocks=[],this.width=a[0].length}TILE_SIZE=32,WIDTH=16,HEIGHT=12,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,KEY_C=67,KEY_X=88,KEY_V=86,KEY_ENTER=13,FRAME_TIME=20,GUESS_LIFE=.3,MIN_PLAYER_DISTANCE=3,INTRODUCTION_DELAY=500,ANIMATION_DELAY=500,Cursor.prototype.move=function(a,b){0>a||0>b||a>=WIDTH||b>=HEIGHT||(this.x=a,this.y=b)},Cursor.prototype.frame=function(a){a.status[KEY_DOWN]?this.move(this.x,this.y+1):a.status[KEY_UP]?this.move(this.x,this.y-1):a.status[KEY_LEFT]?this.move(this.x-1,this.y):a.status[KEY_RIGHT]?this.move(this.x+1,this.y):a.status[KEY_V]?(this.addState++,3==this.addState&&(this.addState=0,sound.ADD.play(),socket.emit("addStrengthToTile",this.x,this.y))):a.status[KEY_X]?(this.removeState++,3==this.removeState&&(this.removeState=0,sound.DEL.play(),socket.emit("removeStrengthToTile",this.x,this.y))):a.status[KEY_C]&&(sound.ROCK.play(),socket.emit("addRock",this.x,this.y))},Cursor.prototype.draw=function(a){game.otherPlayers.distance(this.x,this.y)<MIN_PLAYER_DISTANCE?a.drawImage(res.CURSOR_TOO_CLOSE,this.x*TILE_SIZE,this.y*TILE_SIZE):a.drawImage(res.CURSOR,this.x*TILE_SIZE,this.y*TILE_SIZE)};var game={};Game.prototype.changeWorld=function(a){sound.WIN.play(),this.world.data=a.tiles,this.goal=new Goal(a.goal),this.otherPlayers=new OtherPlayers,this.player=new Player(a.player)},Game.prototype.removePlayer=function(a){this.isGod&&this.otherPlayers.removePlayer(a),this.changeSize(this.size-1)},Game.prototype.changeSize=function(a){this.size=a,$("#playerCount").html("World "+this.id+" : "+this.size+" players")},Game.prototype.frame=function(){for(this.diff+=Date.now()-this.lastTime,this.lastTime=Date.now();this.diff>FRAME_TIME;)this.diff-=FRAME_TIME,this.frameCount++,this.player.isGod?this.frameCount%4==0&&this.cursor.frame(this.keyboard):(this.frameCount%2==0&&this.player.frame(this.keyboard),this.frameCount%10==0&&this.lifebar.guessLife())},Game.prototype.draw=function(){var a=this;this.started&&(this.frame(),this.canvas.fillStyle="rgba(0,0,0,1)",this.canvas.clearRect(0,0,this.canvas.width,this.canvas.height),this.world.draw(this.canvas),this.lifebar.draw(this.canvas),this.goal.draw(this.canvas),this.player.isGod?(this.cursor.draw(this.canvas),this.otherPlayers.draw(this.canvas)):this.player.draw(this.canvas),window.requestAnimationFrame(function(){a.draw()}))},Goal.prototype.draw=function(a){a.drawImage(res.GOAL,this.data.x*TILE_SIZE,this.data.y*TILE_SIZE)},$(document).ready(function(){function a(b){b.keyCode==KEY_ENTER&&(sound.BEGIN.play(),$("body").off("keydown",a),$("#introduction").slideUp(INTRODUCTION_DELAY),setTimeout(function(){$("#gamePlay").slideDown(INTRODUCTION_DELAY),setTimeout(function(){initGame()},INTRODUCTION_DELAY)},INTRODUCTION_DELAY))}$("body").on("keydown",a)}),LifeBar.prototype.updateLife=function(a){this.player.life=a},LifeBar.prototype.guessLife=function(){this.player.life-=GUESS_LIFE},LifeBar.prototype.draw=function(a){game.player.isGod?(a.fillStyle="rgba(10,10,121,0.9)",a.fillRect(0,384,512,8)):(a.fillStyle="rgba(121,10,10,0.9)",a.fillRect(0,384,5.12*this.player.life,8))};var socket;OtherPlayers.prototype.updatePosition=function(a){this.players[a.id]=a},OtherPlayers.prototype.removePlayer=function(a){delete this.players[a]},OtherPlayers.prototype.playerDistance=function(a,b,c){return Math.floor(Math.abs(b-c.y)+Math.abs(a-c.x))},OtherPlayers.prototype.distance=function(a,b){var c=255;for(var d in this.players){var e=this.playerDistance(a,b,this.players[d]);c>e&&(c=e)}return c},OtherPlayers.prototype.draw=function(a){for(var b in this.players){var c=this.players[b];a.drawImage(res.OTHER,c.x*TILE_SIZE,c.y*TILE_SIZE)}},Player.prototype.draw=function(a){a.drawImage(res.PLAYER,this.data.x*TILE_SIZE,this.data.y*TILE_SIZE)},Player.prototype.attack=function(a,b){this.attackState.x==a&&this.attackState.y==b?(this.attackState.n++,game.world.data[b][a].r-=3,(7==this.attackState.n||game.world.data[b][a].r<=0)&&(socket.emit("attack",a,b),this.attackState.n=0)):(this.attackState.x=a,this.attackState.y=b)},Player.prototype.move=function(a,b){return 0>a||a>=WIDTH||0>b||b>=HEIGHT?void 0:game.world.hasRock(a,b)?void sound.BUMP.play():void(game.world.data[b][a].r>0?(sound.DIG.play().loop(),this.attack(a,b)):(sound.DIG.stop(),this.data.x=a,this.data.y=b,socket.emit("move",a,b)))},Player.prototype.frame=function(a){a.status[KEY_DOWN]?this.move(this.data.x,this.data.y+1):a.status[KEY_UP]?this.move(this.data.x,this.data.y-1):a.status[KEY_LEFT]?this.move(this.data.x-1,this.data.y):a.status[KEY_RIGHT]?this.move(this.data.x+1,this.data.y):sound.DIG.play().stop()};var res={};res.CURSOR=new Image,res.CURSOR.src="res/cursor.png",res.CURSOR_TOO_CLOSE=new Image,res.CURSOR_TOO_CLOSE.src="res/cursorTooClose.png",res.GOAL=new Image,res.GOAL.src="res/goal.png",res.OTHER=new Image,res.OTHER.src="res/other.png",res.ROCK=new Image,res.ROCK.src="res/rock.png",res.PLAYER=new Image,res.PLAYER.src="res/player.png";var sound={};sound.ADD=new buzz.sound("res/add",{formats:["wav"]}),sound.BEGIN=new buzz.sound("res/begin",{formats:["wav"]}),sound.BUMP=new buzz.sound("res/bump",{formats:["wav"]}),sound.DEL=new buzz.sound("res/del",{formats:["wav"]}),sound.DIG=new buzz.sound("res/dig",{formats:["wav"]}),sound.LOSE=new buzz.sound("res/lose",{formats:["wav"]}),sound.ROCK=new buzz.sound("res/rock",{formats:["wav"]}),sound.WIN=new buzz.sound("res/win",{formats:["wav"]}),Tile.draw=function(a,b,c,d){a.fillStyle="rgba(0,0,0, "+d.r/100+")",a.fillRect(b,c,TILE_SIZE,TILE_SIZE)},UI.prototype.changeMode=function(a){$("#info").html(""),sound.DIG.stop(),"god"==a?($("#normalMode").hide(),$("#godMode").slideDown(ANIMATION_DELAY)):"normal"==a&&($("#godMode").hide(),$("#normalMode").slideDown(ANIMATION_DELAY))},UI.prototype.showInfo=function(a){$("#info").hide(),$("#info").html(a),$("#info").slideDown(ANIMATION_DELAY),$("#normalMode").slideUp(ANIMATION_DELAY),$("#godMode").slideUp(ANIMATION_DELAY)};var ui=new UI;World.prototype.draw=function(a){for(var b=0;b<this.height;b++)for(var c=0;c<this.width;c++)Tile.draw(a,c*TILE_SIZE,b*TILE_SIZE,this.data[b][c]);this.rocks.forEach(function(b){a.drawImage(res.ROCK,b.x*TILE_SIZE,b.y*TILE_SIZE)})},World.prototype.updateTile=function(a,b,c){this.data[b][a]=c},World.prototype.hasRock=function(a,b){for(var c=0;c<this.rocks.length;c++)if(this.rocks[c].x==a&&this.rocks[c].y==b)return!0;return!1},World.prototype.updateRocks=function(a){this.rocks=a};